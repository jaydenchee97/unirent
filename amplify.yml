version: 1.0
frontend:
  phases:
    preBuild:
      commands:
        - npm install --quiet --global expo-cli
        - >
          if [ -f yarn.lock ]; then
            yarn
          elif [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm install
          fi

    build:
      commands:
        - echo "EXPO_PUBLIC_GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY" >> .env
        - npx expo export --platform web

    postBuild:
      commands:
        - echo "Installing OWASP ZAP"
        - wget https://github.com/zaproxy/zaproxy/releases/download/v2.15.0/ZAP_2_15_0_unix.sh -O zap.sh
        - chmod +x zap.sh
        - ./zap.sh -cmd -daemon -port 8080 -config api.disablekey=true
        - echo "Running OWASP ZAP Scan"
        - zap-cli start --port 8080
        - zap-cli status --port 8080 --timeout 300
        - zap-cli spider http://localhost:8080
        - zap-cli active-scan http://localhost:8080
        - zap-cli report -o zap_report.html -f html
        - zap-cli shutdown

  artifacts:
    baseDirectory: dist
    files:
      - "**/*"
    zapReport:
      baseDirectory: .
      files:
        - zap_report.html

  cache:
    paths:
      - node_modules/**/*
      - $(npm root --global)/**/*
